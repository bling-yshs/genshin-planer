name: ğŸš€ å‘å¸ƒæ–°ç‰ˆæœ¬

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # =======================================================
  # JOB 1: æ ¡éªŒç‰ˆæœ¬å·
  # =======================================================
  validate:
    name: 1ï¸âƒ£ æ ¡éªŒç‰ˆæœ¬å· (Validate version)
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-22.04
    outputs:
      new_version: ${{ steps.compare.outputs.new_version }}
      new_tag: ${{ steps.compare.outputs.new_tag }}
      old_tag: ${{ steps.latest_tag.outputs.tag }}

    steps:
      - name: å…‹éš†ä»“åº“ (Checkout)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: å®‰è£… Node.js (Install Node.js)
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: å®‰è£…è„šæœ¬ä¾èµ– (Install script dependencies)
        working-directory: .github/script
        run: npm install

      - name: è¯»å– tauri.conf.json5 ç‰ˆæœ¬ (Read tauri.conf.json5 version)
        id: tauri_version
        working-directory: .github/script
        run: |
          VERSION=$(npx tsx read-version.ts)
          echo "app_version=$VERSION" >> $GITHUB_OUTPUT
          echo "è¯»å–åˆ°ç‰ˆæœ¬: $VERSION"

      - name: è·å–æœ€æ–°çš„ Git Tag (Get latest Git tag)
        id: latest_tag
        run: |
          LATEST_TAG=$(git tag | grep -E "^v[0-9]+\.[0-9]+\.[0-9]+$" | sort -V | tail -n 1 || echo "v0.0.0")
          echo "æ‰¾åˆ°çš„æœ€æ–°çš„è¯­ä¹‰åŒ–ç‰ˆæœ¬ Tag: $LATEST_TAG"
          echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: æ¯”è¾ƒç‰ˆæœ¬å· (Compare versions)
        id: compare
        run: |
          APP_VERSION=${{ steps.tauri_version.outputs.app_version }}
          LATEST_TAG_VERSION=${{ steps.latest_tag.outputs.tag }}
          LATEST_TAG_VERSION_NUM=${LATEST_TAG_VERSION#v}

          echo "App ç‰ˆæœ¬ (Current): $APP_VERSION"
          echo "Git Tag ç‰ˆæœ¬ (Latest): $LATEST_TAG_VERSION_NUM"

          if [ "$APP_VERSION" = "$LATEST_TAG_VERSION_NUM" ]; then
            echo "::error::tauri.conf.json5 ç‰ˆæœ¬ ($APP_VERSION) ç­‰äºæœ€æ–°çš„ Tag ç‰ˆæœ¬ ($LATEST_TAG_VERSION_NUM)ã€‚è¯·åœ¨å‘å¸ƒå‰æ›´æ–°ç‰ˆæœ¬å·ã€‚"
            exit 1
          fi

          LATEST_VERSION=$(printf "%s\n%s" "$APP_VERSION" "$LATEST_TAG_VERSION_NUM" | sort -V | tail -n 1)

          if [ "$LATEST_VERSION" != "$APP_VERSION" ]; then
            echo "::error::tauri.conf.json5 ç‰ˆæœ¬ ($APP_VERSION) å°äºæœ€æ–°çš„ Tag ç‰ˆæœ¬ ($LATEST_TAG_VERSION_NUM)ã€‚è¯·åœ¨å‘å¸ƒå‰æ›´æ–°ç‰ˆæœ¬å·ã€‚"
            exit 1
          fi

          echo "ç‰ˆæœ¬æ ¡éªŒé€šè¿‡!"
          echo "new_version=$APP_VERSION" >> $GITHUB_OUTPUT
          echo "new_tag=v$APP_VERSION" >> $GITHUB_OUTPUT

  # =======================================================
  # JOB 2: æ„å»º Windows
  # =======================================================
  build-windows:
    name: 2ï¸âƒ£ æ„å»º Windows (Build Windows)
    if: github.ref == 'refs/heads/main'
    needs: validate
    runs-on: windows-latest

    steps:
      - name: æ£€å‡ºä»£ç  (Checkout)
        uses: actions/checkout@v6

      - name: å®‰è£… Rust (Install Rust)
        uses: dtolnay/rust-toolchain@stable

      - name: Rust ç¼“å­˜ (Rust cache)
        uses: swatinem/rust-cache@v2
        with:
          workspaces: ./src-tauri -> target

      - name: å®‰è£… pnpm (Install pnpm)
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: å®‰è£… Node.js (Install Node.js)
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm

      - name: å®‰è£…å‰ç«¯ä¾èµ– (Install frontend dependencies)
        run: pnpm install

      - name: æ„å»ºåº”ç”¨ (Build app)
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: pnpm tauri build

      - name: ä¸Šä¼ æ„å»ºäº§ç‰© (Upload build artifacts)
        uses: actions/upload-artifact@v6
        with:
          name: windows-release
          path: |
            ./src-tauri/target/release/bundle/nsis/*.exe
            ./src-tauri/target/release/bundle/nsis/*.sig
          if-no-files-found: error

  # =======================================================
  # JOB 3: æ„å»º Linux
  # =======================================================
  build-linux:
    name: 2ï¸âƒ£ æ„å»º Linux (Build Linux)
    if: github.ref == 'refs/heads/main'
    needs: validate
    runs-on: ubuntu-22.04

    steps:
      - name: æ£€å‡ºä»£ç  (Checkout)
        uses: actions/checkout@v6

      - name: å®‰è£…ç³»ç»Ÿä¾èµ– (Install system dependencies)
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: å®‰è£… Rust (Install Rust)
        uses: dtolnay/rust-toolchain@stable

      - name: Rust ç¼“å­˜ (Rust cache)
        uses: swatinem/rust-cache@v2
        with:
          workspaces: ./src-tauri -> target

      - name: å®‰è£… pnpm (Install pnpm)
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: å®‰è£… Node.js (Install Node.js)
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm

      - name: å®‰è£…å‰ç«¯ä¾èµ– (Install frontend dependencies)
        run: pnpm install

      - name: æ„å»ºåº”ç”¨ (Build app)
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: pnpm tauri build

      - name: ä¸Šä¼ æ„å»ºäº§ç‰© (Upload build artifacts)
        uses: actions/upload-artifact@v6
        with:
          name: linux-release
          path: |
            ./src-tauri/target/release/bundle/appimage/*.AppImage
            ./src-tauri/target/release/bundle/appimage/*.sig
            ./src-tauri/target/release/bundle/deb/*.deb
            ./src-tauri/target/release/bundle/rpm/*.rpm
          if-no-files-found: error

  # =======================================================
  # JOB 4: æ„å»º macOS
  # =======================================================
  build-macos:
    name: 2ï¸âƒ£ æ„å»º macOS (Build macOS)
    if: github.ref == 'refs/heads/main'
    needs: validate
    runs-on: macos-latest

    steps:
      - name: æ£€å‡ºä»£ç  (Checkout)
        uses: actions/checkout@v6

      - name: å®‰è£… Rust (Install Rust)
        uses: dtolnay/rust-toolchain@stable

      - name: Rust ç¼“å­˜ (Rust cache)
        uses: swatinem/rust-cache@v2
        with:
          workspaces: ./src-tauri -> target

      - name: å®‰è£… pnpm (Install pnpm)
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: å®‰è£… Node.js (Install Node.js)
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm

      - name: å®‰è£…å‰ç«¯ä¾èµ– (Install frontend dependencies)
        run: pnpm install

      - name: æ„å»ºåº”ç”¨ (Build app)
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: pnpm tauri build

      - name: ä¸Šä¼ æ„å»ºäº§ç‰© (Upload build artifacts)
        uses: actions/upload-artifact@v6
        with:
          name: macos-release
          path: |
            ./src-tauri/target/release/bundle/macos/*.app.tar.gz
            ./src-tauri/target/release/bundle/macos/*.sig
            ./src-tauri/target/release/bundle/dmg/*.dmg
          if-no-files-found: error

  # =======================================================
  # JOB 5: ç”Ÿæˆ update.json
  # =======================================================
  generate-update-json:
    name: 3ï¸âƒ£ ç”Ÿæˆ update.json (Generate update.json)
    if: github.ref == 'refs/heads/main'
    needs: [validate, build-windows, build-linux, build-macos]
    runs-on: ubuntu-22.04

    steps:
      - name: æ£€å‡ºä»£ç  (Checkout)
        uses: actions/checkout@v6

      - name: ä¸‹è½½å…¨éƒ¨ Artifact (Download all artifacts)
        uses: actions/download-artifact@v7
        with:
          path: ./artifacts
          merge-multiple: true

      - name: å®‰è£… Node.js (Install Node.js)
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: å®‰è£…è„šæœ¬ä¾èµ– (Install script dependencies)
        working-directory: .github/script
        run: npm install

      - name: ç”Ÿæˆ update.json (Generate update.json)
        working-directory: .github/script
        run: |
          VERSION=${{ needs.validate.outputs.new_version }}
          TAG=${{ needs.validate.outputs.new_tag }}
          BASE_URL="https://github.com/${{ github.repository }}/releases/download/${TAG}"

          npx tsx gen-update.ts \
            --version "$VERSION" \
            --changelog "Release ${TAG}" \
            --artifacts-dir "../../artifacts" \
            --base-url "$BASE_URL"

      - name: ä¸Šä¼  update.json (Upload update.json)
        uses: actions/upload-artifact@v6
        with:
          name: update-json
          path: ./artifacts/update.json
          if-no-files-found: error

  # =======================================================
  # JOB 6: å‘å¸ƒåˆ° GitHub
  # =======================================================
  release-github:
    name: 4ï¸âƒ£ å‘å¸ƒåˆ° GitHub (Release to GitHub)
    if: github.ref == 'refs/heads/main'
    needs: [validate, build-windows, build-linux, build-macos, generate-update-json]
    runs-on: ubuntu-22.04

    steps:
      - name: ä¸‹è½½å…¨éƒ¨ Artifact (Download all artifacts)
        uses: actions/download-artifact@v7
        with:
          path: ./artifacts
          merge-multiple: true

      - name: æ•´ç†æ–‡ä»¶ (Flatten files)
        run: |
          mkdir -p ./release-files
          find ./artifacts -type f -exec cp {} ./release-files/ \;
          ls -la ./release-files/

      - name: åˆ›å»º GitHub Release (Create GitHub Release)
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ needs.validate.outputs.new_tag }}
          name: ${{ needs.validate.outputs.new_tag }}
          body: |
            ## ğŸ‰ ${{ needs.validate.outputs.new_tag }}

            ---
            **Full Changelog**: ${{ github.server_url }}/${{ github.repository }}/compare/${{ needs.validate.outputs.old_tag }}...${{ needs.validate.outputs.new_tag }}
          prerelease: false
          artifacts: ./release-files/*

  # =======================================================
  # JOB 7: å‘å¸ƒåˆ° CNB
  # =======================================================
  release-cnb:
    name: 5ï¸âƒ£ å‘å¸ƒåˆ° CNB (Release to CNB)
    if: github.ref == 'refs/heads/main'
    needs: [validate, build-windows, build-linux, build-macos, generate-update-json]
    runs-on: ubuntu-22.04

    steps:
      - name: æ£€å‡ºä»£ç  (Checkout)
        uses: actions/checkout@v6

      - name: ä¸‹è½½å…¨éƒ¨ Artifact (Download all artifacts)
        uses: actions/download-artifact@v7
        with:
          path: ./artifacts
          merge-multiple: true

      - name: å®‰è£… Node.js (Install Node.js)
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: å®‰è£…è„šæœ¬ä¾èµ– (Install script dependencies)
        working-directory: .github/script
        run: npm install

      - name: å‘å¸ƒåˆ° CNB (Release to CNB)
        working-directory: .github/script
        env:
          CNB_GIT_TOKEN: ${{ secrets.CNB_GIT_TOKEN }}
        run: |
          TAG=${{ needs.validate.outputs.new_tag }}
          CHANGELOG="Release ${TAG}"

          # æ”¶é›†æ‰€æœ‰æ–‡ä»¶
          FILES=$(find ../../artifacts -type f | tr '\n' ' ')

          npx tsx release-cnb.ts \
            --token "$CNB_GIT_TOKEN" \
            --tag "$TAG" \
            --changelog "$CHANGELOG" \
            --files $FILES
