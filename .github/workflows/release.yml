name: ğŸš€ å‘å¸ƒæ–°ç‰ˆæœ¬

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  # =======================================================
  # JOB 1: æ ¡éªŒç‰ˆæœ¬å·
  # =======================================================
  validate:
    name: 1ï¸âƒ£ æ ¡éªŒç‰ˆæœ¬å· (Validate version)
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-22.04
    outputs:
      new_version: ${{ steps.compare.outputs.new_version }}
      new_tag: ${{ steps.compare.outputs.new_tag }}
      old_tag: ${{ steps.latest_tag.outputs.tag }}

    steps:
      - name: å…‹éš†ä»“åº“ (Checkout)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: å®‰è£… Node.js (Install Node.js)
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: å®‰è£…è„šæœ¬ä¾èµ– (Install script dependencies)
        working-directory: .github/script
        run: npm install

      - name: è¯»å– tauri.conf.json5 ç‰ˆæœ¬ (Read tauri.conf.json5 version)
        id: tauri_version
        working-directory: .github/script
        run: |
          VERSION=$(npx tsx read-version.ts)
          echo "app_version=$VERSION" >> $GITHUB_OUTPUT
          echo "è¯»å–åˆ°ç‰ˆæœ¬: $VERSION"

      - name: è·å–æœ€æ–°çš„ Git Tag (Get latest Git tag)
        id: latest_tag
        run: |
          LATEST_TAG=$(git tag | grep -E "^v[0-9]+\.[0-9]+\.[0-9]+$" | sort -V | tail -n 1 || echo "v0.0.0")
          echo "æ‰¾åˆ°çš„æœ€æ–°çš„è¯­ä¹‰åŒ–ç‰ˆæœ¬ Tag: $LATEST_TAG"
          echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: æ¯”è¾ƒç‰ˆæœ¬å· (Compare versions)
        id: compare
        run: |
          APP_VERSION=${{ steps.tauri_version.outputs.app_version }}
          LATEST_TAG_VERSION=${{ steps.latest_tag.outputs.tag }}
          LATEST_TAG_VERSION_NUM=${LATEST_TAG_VERSION#v}

          echo "App ç‰ˆæœ¬ (Current): $APP_VERSION"
          echo "Git Tag ç‰ˆæœ¬ (Latest): $LATEST_TAG_VERSION_NUM"

          if [ "$APP_VERSION" = "$LATEST_TAG_VERSION_NUM" ]; then
            echo "::error::tauri.conf.json5 ç‰ˆæœ¬ ($APP_VERSION) ç­‰äºæœ€æ–°çš„ Tag ç‰ˆæœ¬ ($LATEST_TAG_VERSION_NUM)ã€‚è¯·åœ¨å‘å¸ƒå‰æ›´æ–°ç‰ˆæœ¬å·ã€‚"
            exit 1
          fi

          LATEST_VERSION=$(printf "%s\n%s" "$APP_VERSION" "$LATEST_TAG_VERSION_NUM" | sort -V | tail -n 1)

          if [ "$LATEST_VERSION" != "$APP_VERSION" ]; then
            echo "::error::tauri.conf.json5 ç‰ˆæœ¬ ($APP_VERSION) å°äºæœ€æ–°çš„ Tag ç‰ˆæœ¬ ($LATEST_TAG_VERSION_NUM)ã€‚è¯·åœ¨å‘å¸ƒå‰æ›´æ–°ç‰ˆæœ¬å·ã€‚"
            exit 1
          fi

          echo "ç‰ˆæœ¬æ ¡éªŒé€šè¿‡!"
          echo "new_version=$APP_VERSION" >> $GITHUB_OUTPUT
          echo "new_tag=v$APP_VERSION" >> $GITHUB_OUTPUT

  # =======================================================
  # JOB 2: æ„å»ºæ‰€æœ‰å¹³å° (Matrix)
  # =======================================================
  build:
    name: 2ï¸âƒ£ æ„å»º ${{ matrix.settings.name }}
    if: github.ref == 'refs/heads/main'
    needs: validate
    strategy:
      fail-fast: false
      matrix:
        settings:
          - name: ğŸªŸ Windows x64
            os: windows-latest
            platform: windows
            artifact-name: windows-x64-release
            artifact-path: |
              ./src-tauri/target/release/bundle/nsis/*.exe
              ./src-tauri/target/release/bundle/nsis/*.sig

          - name: ğŸªŸ Windows ARM64
            os: windows-11-arm
            platform: windows-arm64
            artifact-name: windows-arm64-release
            artifact-path: |
              ./src-tauri/target/release/bundle/nsis/*.exe
              ./src-tauri/target/release/bundle/nsis/*.sig

          - name: ğŸ§ Linux x64
            os: ubuntu-22.04
            platform: linux
            artifact-name: linux-x64-release
            artifact-path: |
              ./src-tauri/target/release/bundle/deb/*.deb
              ./src-tauri/target/release/bundle/rpm/*.rpm

          - name: ğŸ§ Linux ARM64
            os: ubuntu-22.04-arm
            platform: linux-arm64
            artifact-name: linux-arm64-release
            artifact-path: |
              ./src-tauri/target/release/bundle/deb/*.deb
              ./src-tauri/target/release/bundle/rpm/*.rpm

          - name: ğŸ macOS (Apple Silicon)
            os: macos-latest
            platform: macos
            artifact-name: macos-arm64-release
            artifact-path: |
              ./src-tauri/target/release/bundle/macos/*.app.tar.gz
              ./src-tauri/target/release/bundle/macos/*.sig
              ./src-tauri/target/release/bundle/dmg/*.dmg

          - name: ğŸ macOS (Intel)
            os: macos-15-intel
            platform: macos-intel
            artifact-name: macos-intel-release
            artifact-path: |
              ./src-tauri/target/release/bundle/macos/*.app.tar.gz
              ./src-tauri/target/release/bundle/macos/*.sig
              ./src-tauri/target/release/bundle/dmg/*.dmg

    runs-on: ${{ matrix.settings.os }}

    steps:
      - name: æ£€å‡ºä»£ç  (Checkout)
        uses: actions/checkout@v6

      - name: æ„å»ºåº”ç”¨ (Build app)
        uses: ./.github/actions/build-tauri
        with:
          platform: ${{ matrix.settings.platform }}
          signing-private-key: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          signing-private-key-password: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: ä¸Šä¼ æ„å»ºäº§ç‰© (Upload build artifacts)
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.settings.artifact-name }}
          path: ${{ matrix.settings.artifact-path }}
          if-no-files-found: error

  # =======================================================
  # JOB 3: ç”Ÿæˆå…ƒæ•°æ®
  # =======================================================
  generate-metadata:
    name: 3ï¸âƒ£ ç”Ÿæˆå…ƒæ•°æ® (Generate metadata)
    if: github.ref == 'refs/heads/main'
    needs: [validate, build]
    runs-on: ubuntu-22.04
    outputs:
      changelog: ${{ steps.changelog_reader.outputs.changes }}
      changelog_link: ${{ steps.changelog_link.outputs.url }}

    steps:
      - name: æ£€å‡ºä»£ç  (Checkout)
        uses: actions/checkout@v6

      - name: ä¸‹è½½å…¨éƒ¨ Artifact (Download all artifacts)
        uses: actions/download-artifact@v7
        with:
          path: ./artifacts
          merge-multiple: true

      - name: å®‰è£… Node.js (Install Node.js)
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: å®‰è£…è„šæœ¬ä¾èµ– (Install script dependencies)
        working-directory: .github/script
        run: npm install

      - name: è¯»å– Changelog (Read Changelog)
        id: changelog_reader
        uses: mindsers/changelog-reader-action@v2.2.3
        with:
          version: 'Unreleased'
          path: './CHANGELOG.md'

      - name: ç”Ÿæˆ Full Changelog é“¾æ¥ (Generate Full Changelog link)
        id: changelog_link
        run: |
          echo "url=${{ github.server_url }}/${{ github.repository }}/compare/${{ needs.validate.outputs.old_tag }}...${{ needs.validate.outputs.new_tag }}" >> $GITHUB_OUTPUT

      - name: ç”Ÿæˆ update.json (Generate update.json)
        working-directory: .github/script
        run: |
          VERSION=${{ needs.validate.outputs.new_version }}
          TAG=${{ needs.validate.outputs.new_tag }}
          BASE_URL="https://github.com/${{ github.repository }}/releases/download/${TAG}"
          CHANGELOG='${{ steps.changelog_reader.outputs.changes }}'

          npx tsx gen-update.ts \
            --version "$VERSION" \
            --changelog "$CHANGELOG" \
            --artifacts-dir "../../artifacts" \
            --base-url "$BASE_URL"

      - name: ä¸Šä¼  update.json (Upload update.json)
        uses: actions/upload-artifact@v6
        with:
          name: update-json
          path: ./artifacts/update.json
          if-no-files-found: error

  # =======================================================
  # JOB 4: å‘å¸ƒåˆ° GitHub
  # =======================================================
  release-github:
    name: 4ï¸âƒ£ å‘å¸ƒåˆ° GitHub (Release to GitHub)
    if: github.ref == 'refs/heads/main'
    needs: [validate, build, generate-metadata]
    runs-on: ubuntu-22.04

    steps:
      - name: æ£€å‡ºä»£ç  (Checkout)
        uses: actions/checkout@v6

      - name: ä¸‹è½½å…¨éƒ¨ Artifact (Download all artifacts)
        uses: actions/download-artifact@v7
        with:
          path: ./artifacts
          merge-multiple: true

      - name: æ•´ç†æ–‡ä»¶ (Flatten files)
        run: |
          mkdir -p ./release-files
          find ./artifacts -type f -exec cp {} ./release-files/ \;
          ls -la ./release-files/

      - name: å®‰è£… Node.js (Install Node.js)
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: å®‰è£…è„šæœ¬ä¾èµ– (Install script dependencies)
        working-directory: .github/script
        run: npm install

      - name: ç”Ÿæˆ Release Body (Generate Release Body)
        id: release_body
        working-directory: .github/script
        run: |
          TAG=${{ needs.validate.outputs.new_tag }}
          VERSION=${{ needs.validate.outputs.new_version }}
          CHANGELOG='${{ needs.generate-metadata.outputs.changelog }}'
          CHANGELOG_LINK='${{ needs.generate-metadata.outputs.changelog_link }}'

          BODY=$(npx tsx gen-release-body.ts \
            --version "$VERSION" \
            --tag "$TAG" \
            --changelog "$CHANGELOG" \
            --changelog-link "$CHANGELOG_LINK" \
            --platform "github")

          # ä½¿ç”¨ heredoc å†™å…¥å¤šè¡Œå†…å®¹
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: åˆ›å»º GitHub Release (Create GitHub Release)
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ needs.validate.outputs.new_tag }}
          name: ${{ needs.validate.outputs.new_tag }}
          body: ${{ steps.release_body.outputs.body }}
          prerelease: false
          artifacts: ./release-files/*

  # =======================================================
  # JOB 5: å‘å¸ƒåˆ° CNB
  # =======================================================
  release-cnb:
    name: 5ï¸âƒ£ å‘å¸ƒåˆ° CNB (Release to CNB)
    if: github.ref == 'refs/heads/main'
    needs: [validate, build, generate-metadata]
    runs-on: ubuntu-22.04

    steps:
      - name: æ£€å‡ºä»£ç  (Checkout)
        uses: actions/checkout@v6

      - name: ä¸‹è½½å…¨éƒ¨ Artifact (Download all artifacts)
        uses: actions/download-artifact@v7
        with:
          path: ./artifacts
          merge-multiple: true

      - name: æ•´ç†æ–‡ä»¶ (Flatten files)
        run: |
          mkdir -p ./release-files
          find ./artifacts -type f -exec cp {} ./release-files/ \;
          ls -la ./release-files/

      - name: å®‰è£… Node.js (Install Node.js)
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: å®‰è£…è„šæœ¬ä¾èµ– (Install script dependencies)
        working-directory: .github/script
        run: npm install

      - name: ç”Ÿæˆ Release Body (Generate Release Body)
        id: release_body
        working-directory: .github/script
        run: |
          TAG=${{ needs.validate.outputs.new_tag }}
          VERSION=${{ needs.validate.outputs.new_version }}
          CHANGELOG='${{ needs.generate-metadata.outputs.changelog }}'
          CHANGELOG_LINK='${{ needs.generate-metadata.outputs.changelog_link }}'

          BODY=$(npx tsx gen-release-body.ts \
            --version "$VERSION" \
            --tag "$TAG" \
            --changelog "$CHANGELOG" \
            --changelog-link "$CHANGELOG_LINK" \
            --platform "cnb")

          # ä½¿ç”¨ heredoc å†™å…¥å¤šè¡Œå†…å®¹
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: å‘å¸ƒåˆ° CNB (Release to CNB)
        working-directory: .github/script
        env:
          CNB_GIT_TOKEN: ${{ secrets.CNB_GIT_TOKEN }}
        run: |
          TAG=${{ needs.validate.outputs.new_tag }}
          CHANGELOG='${{ steps.release_body.outputs.body }}'

          # æ”¶é›†æ‰€æœ‰æ–‡ä»¶
          FILES=$(find ../../release-files -type f | tr '\n' ' ')

          npx tsx release-cnb.ts \
            --token "$CNB_GIT_TOKEN" \
            --tag "$TAG" \
            --changelog "$CHANGELOG" \
            --files $FILES

  # =======================================================
  # JOB 6: æ›´æ–° CHANGELOG å¹¶åˆ›å»º PR
  # =======================================================
  update-changelog:
    name: 6ï¸âƒ£ æ›´æ–° CHANGELOG (Update CHANGELOG)
    if: github.ref == 'refs/heads/main'
    needs: [validate, release-github]
    runs-on: ubuntu-22.04

    steps:
      - name: å…‹éš†ä»“åº“ (Checkout)
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: é…ç½® Git (Configure Git)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: æ›´æ–° CHANGELOG.md (Update CHANGELOG.md)
        env:
          NEW_VERSION: ${{ needs.validate.outputs.new_version }}
          NEW_TAG: ${{ needs.validate.outputs.new_tag }}
          OLD_TAG: ${{ needs.validate.outputs.old_tag }}
        run: |
          TODAY=$(date +'%Y-%m-%d')
          REPO_URL="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY"
          FILE="./CHANGELOG.md"

          # 1. å‡†å¤‡æ–°é“¾æ¥
          NEW_UNRELEASED_LINK_LINE="[Unreleased]: ${REPO_URL}/compare/${NEW_TAG}...HEAD"
          NEW_VERSION_LINK_LINE="[${NEW_VERSION}]: ${REPO_URL}/commits/${NEW_TAG}"

          # 2. æ›¿æ¢ [Unreleased] æ ‡é¢˜ä¸ºæ–°ç‰ˆæœ¬æ ‡é¢˜
          sed -i.bak "s|## \[Unreleased\]|## \[${NEW_VERSION}\] - ${TODAY}|" $FILE

          # 3. åœ¨æ–‡ä»¶ä¸»æ ‡é¢˜ä¸‹æ–¹æ·»åŠ æ–°çš„ [Unreleased] å—
          sed -i.bak "/^# .*/a \\
          \\
          ## [Unreleased]
          " $FILE

          # 4. æ›¿æ¢æ—§çš„ Unreleased é“¾æ¥
          sed -i.bak "s|^\[Unreleased\]:.*|${NEW_UNRELEASED_LINK_LINE}|" $FILE

          # 5. åœ¨ Unreleased é“¾æ¥ä¸‹é¢æ·»åŠ æ–°ç‰ˆæœ¬çš„é“¾æ¥
          sed -i.bak "/^\[Unreleased\]:/a ${NEW_VERSION_LINK_LINE}" $FILE

          # 6. åˆ é™¤å¤‡ä»½æ–‡ä»¶
          rm -f $FILE.bak

          echo "--- CHANGELOG.md after update: ---"
          cat $FILE
          echo "-----------------------------------"

      - name: åˆ›å»º PR (Create PR)
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: è‡ªåŠ¨æ›´æ–° CHANGELOG.md v${{ needs.validate.outputs.new_version }}"
          branch: "chore/update-changelog-${{ needs.validate.outputs.new_version }}"
          base: "main"
          title: "chore: è‡ªåŠ¨æ›´æ–° CHANGELOG.md v${{ needs.validate.outputs.new_version }}"
          body: |
            è‡ªåŠ¨æ›´æ–° CHANGELOG.md v${{ needs.validate.outputs.new_version }}

            - å°† `[Unreleased]` é‡å‘½åä¸º `[${{ needs.validate.outputs.new_version }}]`
            - æ·»åŠ æ–°çš„ç©º `[Unreleased]` å—
            - æ›´æ–°åº•éƒ¨é“¾æ¥
          delete-branch: true
