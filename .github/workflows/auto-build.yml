name: ğŸ› ï¸ è‡ªåŠ¨æ„å»º

on:
  workflow_dispatch:
  push:
  pull_request_target:
    branches:
      - main

jobs:
  build-windows:
    name: ğŸªŸ æ„å»º Windows
    runs-on: windows-latest

    steps:
      - name: é€‰æ‹© Checkout ç›®æ ‡ (Decide repo/ref)
        id: pick
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "pull_request_target" ]; then
            echo "repo=${{ github.event.pull_request.head.repo.full_name }}" >> $GITHUB_OUTPUT
            echo "ref=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
          else
            echo "repo=${{ github.repository }}" >> $GITHUB_OUTPUT
            echo "ref=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: æ£€å‡ºä»£ç  (Checkout)
        uses: actions/checkout@v6
        with:
          repository: ${{ steps.pick.outputs.repo }}
          ref: ${{ steps.pick.outputs.ref }}
          fetch-depth: 0
          persist-credentials: false

      - name: å®‰è£… Rust (Install Rust)
        uses: dtolnay/rust-toolchain@stable

      - name: Rust ç¼“å­˜ (Rust cache)
        uses: swatinem/rust-cache@v2
        with:
          workspaces: ./src-tauri -> target

      - name: å®‰è£… pnpm (Install pnpm)
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: å®‰è£… Node.js (Install Node.js)
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm

      - name: å®‰è£…å‰ç«¯ä¾èµ– (Install frontend dependencies)
        run: pnpm install

      - name: æ„å»ºåº”ç”¨ (Build app)
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: pnpm tauri build

      - name: ä¸Šä¼ æ„å»ºäº§ç‰© (Upload build artifacts)
        uses: actions/upload-artifact@v6
        with:
          name: windows-${{ github.sha }}
          path: |
            ./src-tauri/target/release/bundle/nsis/*.exe
            ./src-tauri/target/release/bundle/nsis/*.sig
          if-no-files-found: error

  build-linux:
    name: ğŸ§ æ„å»º Linux
    runs-on: ubuntu-22.04

    steps:
      - name: é€‰æ‹© Checkout ç›®æ ‡ (Decide repo/ref)
        id: pick
        run: |
          if [ "${{ github.event_name }}" = "pull_request_target" ]; then
            echo "repo=${{ github.event.pull_request.head.repo.full_name }}" >> $GITHUB_OUTPUT
            echo "ref=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
          else
            echo "repo=${{ github.repository }}" >> $GITHUB_OUTPUT
            echo "ref=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: æ£€å‡ºä»£ç  (Checkout)
        uses: actions/checkout@v6
        with:
          repository: ${{ steps.pick.outputs.repo }}
          ref: ${{ steps.pick.outputs.ref }}
          fetch-depth: 0
          persist-credentials: false

      - name: å®‰è£…ç³»ç»Ÿä¾èµ– (Install system dependencies)
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: å®‰è£… Rust (Install Rust)
        uses: dtolnay/rust-toolchain@stable

      - name: Rust ç¼“å­˜ (Rust cache)
        uses: swatinem/rust-cache@v2
        with:
          workspaces: ./src-tauri -> target

      - name: å®‰è£… pnpm (Install pnpm)
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: å®‰è£… Node.js (Install Node.js)
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm

      - name: å®‰è£…å‰ç«¯ä¾èµ– (Install frontend dependencies)
        run: pnpm install

      - name: æ„å»ºåº”ç”¨ (Build app)
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: pnpm tauri build

      - name: ä¸Šä¼ æ„å»ºäº§ç‰© (Upload build artifacts)
        uses: actions/upload-artifact@v6
        with:
          name: linux-${{ github.sha }}
          path: |
            ./src-tauri/target/release/bundle/appimage/*.AppImage
            ./src-tauri/target/release/bundle/appimage/*.sig
            ./src-tauri/target/release/bundle/deb/*.deb
            ./src-tauri/target/release/bundle/rpm/*.rpm
          if-no-files-found: error

  build-macos:
    name: ğŸ æ„å»º macOS
    runs-on: macos-latest

    steps:
      - name: é€‰æ‹© Checkout ç›®æ ‡ (Decide repo/ref)
        id: pick
        run: |
          if [ "${{ github.event_name }}" = "pull_request_target" ]; then
            echo "repo=${{ github.event.pull_request.head.repo.full_name }}" >> $GITHUB_OUTPUT
            echo "ref=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
          else
            echo "repo=${{ github.repository }}" >> $GITHUB_OUTPUT
            echo "ref=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: æ£€å‡ºä»£ç  (Checkout)
        uses: actions/checkout@v6
        with:
          repository: ${{ steps.pick.outputs.repo }}
          ref: ${{ steps.pick.outputs.ref }}
          fetch-depth: 0
          persist-credentials: false

      - name: å®‰è£… Rust (Install Rust)
        uses: dtolnay/rust-toolchain@stable

      - name: Rust ç¼“å­˜ (Rust cache)
        uses: swatinem/rust-cache@v2
        with:
          workspaces: ./src-tauri -> target

      - name: å®‰è£… pnpm (Install pnpm)
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: å®‰è£… Node.js (Install Node.js)
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm

      - name: å®‰è£…å‰ç«¯ä¾èµ– (Install frontend dependencies)
        run: pnpm install

      - name: æ„å»ºåº”ç”¨ (Build app)
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: pnpm tauri build

      - name: ä¸Šä¼ æ„å»ºäº§ç‰© (Upload build artifacts)
        uses: actions/upload-artifact@v6
        with:
          name: macos-${{ github.sha }}
          path: |
            ./src-tauri/target/release/bundle/macos/*.app.tar.gz
            ./src-tauri/target/release/bundle/macos/*.sig
            ./src-tauri/target/release/bundle/dmg/*.dmg
          if-no-files-found: error

  upload-to-release-alpha:
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    name: ğŸ“¤ ä¸Šä¼ åˆ° alpha ç‰ˆæœ¬ (Upload to alpha release)
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-22.04

    steps:
      - name: æ£€å‡ºä»£ç  (Checkout)
        uses: actions/checkout@v6

      - name: ä¸‹è½½å…¨éƒ¨ Artifact (Download all artifacts)
        uses: actions/download-artifact@v7
        with:
          path: ./download
          merge-multiple: true

      - name: ä¸Šä¼ åˆ° alpha é¢„å‘å¸ƒç‰ˆæœ¬ (Upload to alpha pre-release)
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: alpha
          name: Alpha Build
          commit: ${{ github.sha }}
          body: |
            ğŸš§ **Alpha é¢„è§ˆç‰ˆæœ¬**

            æ­¤ç‰ˆæœ¬ç”± CI è‡ªåŠ¨æ„å»ºï¼ŒåŒ…å«æœ€æ–°çš„ä»£ç å˜æ›´ã€‚

            ---
            **Commit**: ${{ github.sha }}
          allowUpdates: true
          removeArtifacts: true
          prerelease: true
          artifacts: ./download/**/*
