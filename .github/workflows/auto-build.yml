name: ğŸ› ï¸ è‡ªåŠ¨æ„å»º

on:
  workflow_dispatch:
  push:
  pull_request_target:
    branches:
      - main

permissions:
  contents: write

jobs:
  # =======================================================
  # JOB 1: æ„å»ºæ‰€æœ‰å¹³å° (Matrix)
  # =======================================================
  build:
    name: ğŸ”¨ æ„å»º ${{ matrix.settings.name }}
    strategy:
      fail-fast: false
      matrix:
        settings:
          - name: ğŸªŸ Windows x64
            os: windows-latest
            platform: windows
            artifact-name: windows-x64
            artifact-path: |
              ./src-tauri/target/release/bundle/nsis/*.exe
              ./src-tauri/target/release/bundle/nsis/*.sig

          - name: ğŸªŸ Windows ARM64
            os: windows-11-arm
            platform: windows-arm64
            artifact-name: windows-arm64
            artifact-path: |
              ./src-tauri/target/release/bundle/nsis/*.exe
              ./src-tauri/target/release/bundle/nsis/*.sig

          - name: ğŸ§ Linux x64
            os: ubuntu-22.04
            platform: linux
            artifact-name: linux-x64
            artifact-path: |
              ./src-tauri/target/release/bundle/deb/*.deb
              ./src-tauri/target/release/bundle/rpm/*.rpm

          - name: ğŸ§ Linux ARM64
            os: ubuntu-22.04-arm
            platform: linux-arm64
            artifact-name: linux-arm64
            artifact-path: |
              ./src-tauri/target/release/bundle/deb/*.deb
              ./src-tauri/target/release/bundle/rpm/*.rpm

          - name: ğŸ macOS (Apple Silicon)
            os: macos-latest
            platform: macos
            artifact-name: macos-arm64
            artifact-path: |
              ./src-tauri/target/release/bundle/macos/*.app.tar.gz
              ./src-tauri/target/release/bundle/macos/*.sig
              ./src-tauri/target/release/bundle/dmg/*.dmg

          - name: ğŸ macOS (Intel)
            os: macos-15-intel
            platform: macos-intel
            artifact-name: macos-intel
            artifact-path: |
              ./src-tauri/target/release/bundle/macos/*.app.tar.gz
              ./src-tauri/target/release/bundle/macos/*.sig
              ./src-tauri/target/release/bundle/dmg/*.dmg

    runs-on: ${{ matrix.settings.os }}

    steps:
      - name: é€‰æ‹© Checkout ç›®æ ‡ (Decide repo/ref)
        id: pick
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "pull_request_target" ]; then
            echo "repo=${{ github.event.pull_request.head.repo.full_name }}" >> $GITHUB_OUTPUT
            echo "ref=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
          else
            echo "repo=${{ github.repository }}" >> $GITHUB_OUTPUT
            echo "ref=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: æ£€å‡ºä»£ç  (Checkout)
        uses: actions/checkout@v6
        with:
          repository: ${{ steps.pick.outputs.repo }}
          ref: ${{ steps.pick.outputs.ref }}
          fetch-depth: 0
          persist-credentials: false

      - name: æ„å»ºåº”ç”¨ (Build app)
        uses: ./.github/actions/build-tauri
        with:
          platform: ${{ matrix.settings.platform }}
          signing-private-key: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          signing-private-key-password: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: ä¸Šä¼ æ„å»ºäº§ç‰© (Upload build artifacts)
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.settings.artifact-name }}-${{ github.sha }}
          path: ${{ matrix.settings.artifact-path }}
          if-no-files-found: error

  # =======================================================
  # JOB 2: ä¸Šä¼ åˆ° Alpha Release
  # =======================================================
  upload-to-release-alpha:
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    name: ğŸ“¤ ä¸Šä¼ åˆ° alpha ç‰ˆæœ¬ (Upload to alpha release)
    needs: build
    runs-on: ubuntu-22.04

    steps:
      - name: æ£€å‡ºä»£ç  (Checkout)
        uses: actions/checkout@v6

      - name: ä¸‹è½½å…¨éƒ¨ Artifact (Download all artifacts)
        uses: actions/download-artifact@v7
        with:
          path: ./artifacts
          merge-multiple: true

      - name: æ•´ç†æ–‡ä»¶ (Flatten files)
        run: |
          mkdir -p ./release-files
          find ./artifacts -type f -exec cp {} ./release-files/ \;
          ls -la ./release-files/

      - name: å®‰è£… Node.js (Install Node.js)
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: å®‰è£…è„šæœ¬ä¾èµ– (Install script dependencies)
        working-directory: .github/script
        run: npm install

      - name: ç”Ÿæˆ Release Body (Generate Release Body)
        id: release_body
        working-directory: .github/script
        run: |
          BODY=$(npx tsx gen-release-body.ts --alpha --commit "${{ github.sha }}")

          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ä¸Šä¼ åˆ° alpha é¢„å‘å¸ƒç‰ˆæœ¬ (Upload to alpha pre-release)
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: alpha
          name: Alpha Build
          commit: ${{ github.sha }}
          body: ${{ steps.release_body.outputs.body }}
          allowUpdates: true
          removeArtifacts: true
          prerelease: true
          artifacts: ./release-files/*
